<h1><strong>TerMoonUs: Formal Technical Specification (v1.0)</strong></h1><p></p><p><em>A Lua‑centric Hybrid Terminal Environment for .NET 10 / C# 14</em></p><p></p><h2><strong>1. Overview</strong></h2><p></p><p>TerMoonUs is a <strong>Blazor Hybrid</strong>, <strong>.NET 10</strong>, <strong>C# 14</strong> application providing a <strong>minimal, Lua‑focused terminal environment</strong>. It is designed primarily for:</p><p></p><ul><li><p><strong>Running Lua CLIs</strong> (source <code>.lua</code> and bytecode <code>.luac</code>)</p><p></p></li><li><p><strong>Providing a consistent UI/UX layer</strong> for Lua scripts through a built‑in API</p><p></p></li><li><p><strong>Supporting customizable prompts and themes</strong></p><p></p></li><li><p><strong>Mapping interpreter paths to CLI folders</strong> via a deterministic folder‑naming scheme</p><p></p></li></ul><p></p><p>The system is <strong>session‑based</strong>, <strong>config‑driven</strong>, and <strong>extensible</strong>.</p><p></p><h2><strong>2. Directory Structure Specification</strong></h2><p></p><h3><strong>2.1 Installation Root</strong></h3><p></p><p>Code</p><pre><code>&lt;InstallRoot&gt;/
  TerMoonUs (executable or app bundle)
  TerMoonUs-Settings/
</code></pre><h3><strong>2.2 Required Subdirectory: </strong><code>TerMoonUs-Settings/</code></h3><p></p><p>TerMoonUs MUST locate this directory at:</p><p></p><p>Code</p><pre><code>./TerMoonUs-Settings
</code></pre><p>relative to the executable.<br>If missing, TerMoonUs MUST:</p><p></p><ul><li><p>Fail with a clear error, OR</p><p></p></li><li><p>Start with fallback defaults (implementation choice)</p><p></p></li></ul><p></p><h3><strong>2.3 Contents of </strong><code>TerMoonUs-Settings/</code></h3><p></p><p>Code</p><pre><code>TerMoonUs-Settings/
  PROMPT.xml
  Bin/
    &lt;interpreter-folder&gt;/
      &lt;lua scripts&gt;
</code></pre><h2><strong>3. PROMPT Configuration Specification</strong></h2><p></p><h3><strong>3.1 File Location</strong></h3><p></p><p>Code</p><pre><code>TerMoonUs-Settings/PROMPT.xml
</code></pre><h3><strong>3.2 XML Schema</strong></h3><p></p><p>The file MUST contain a <code>&lt;prompt&gt;</code> root element.<br>Inside it, TerMoonUs MUST support one or more <strong>color‑tagged text segments</strong>.</p><p></p><h4><strong>Allowed Format A (compact):</strong></h4><p></p><p>Code</p><pre><code>&lt;prompt&gt;
  &lt;color=#RRGGBB&gt;text&lt;/color&gt;
  &lt;color=#RRGGBB&gt;text&lt;/color&gt;
&lt;/prompt&gt;
</code></pre><h4><strong>Allowed Format B (verbose):</strong></h4><p></p><p>Code</p><pre><code>&lt;prompt&gt;
  &lt;segment&gt;
    &lt;color&gt;#RRGGBB&lt;/color&gt;
    &lt;text&gt;text&lt;/text&gt;
  &lt;/segment&gt;
&lt;/prompt&gt;
</code></pre><h3><strong>3.3 Variable Substitution</strong></h3><p></p><p>TerMoonUs MUST support runtime variables inside text nodes:</p><p></p><ul><li><p><code>{current_path}</code></p><p></p></li><li><p><code>{time}</code></p><p></p></li><li><p><code>{user}</code></p><p></p></li><li><p><code>{session_id}</code></p><p></p></li></ul><p></p><h3><strong>3.4 Rendering Rules</strong></h3><p></p><ul><li><p>Segments MUST be rendered in order.</p><p></p></li><li><p>Each segment MUST apply its specified color.</p><p></p></li><li><p>If a segment uses <code>color=dynamic</code>, TerMoonUs MUST substitute the current RGB‑flow color.</p><p></p></li></ul><p></p><h2><strong>4. Interpreter Mapping Specification</strong></h2><p></p><h3><strong>4.1 Folder Naming Convention</strong></h3><p></p><p>Interpreter folders inside <code>Bin/</code> MUST be named using:</p><p></p><ul><li><p>The <strong>absolute path</strong> of the interpreter</p><p></p></li><li><p>With <code>/</code> replaced by <code>.</code></p><p></p></li><li><p>Without a leading dot</p><p></p></li></ul><p></p><h4>Example</h4><p></p><p>Interpreter path:</p><p></p><p>Code</p><pre><code>/usr/bin/lua
</code></pre><p>Folder name:</p><p></p><p>Code</p><pre><code>usr.bin.lua
</code></pre><h3><strong>4.2 Decoding Rule</strong></h3><p></p><p>TerMoonUs MUST decode folder names as:</p><p></p><p>Code</p><pre><code>decoded_path = "/" + folder_name.replace(".", "/")
</code></pre><h3><strong>4.3 Interpreter Validation</strong></h3><p></p><p>At startup, TerMoonUs MUST:</p><p></p><ol><li><p>Enumerate all subfolders of <code>Bin/</code></p><p></p></li><li><p>Decode each folder name into an interpreter path</p><p></p></li><li><p>Validate that the interpreter exists and is executable</p><p></p></li><li><p>Register all <code>.lua</code> and <code>.luac</code> files inside that folder as runnable CLIs</p><p></p></li></ol><p></p><h2><strong>5. CLI Execution Model</strong></h2><p></p><h3><strong>5.1 CLI Discovery</strong></h3><p></p><p>For each interpreter folder:</p><p></p><ul><li><p>Each <code>.lua</code> or <code>.luac</code> file MUST be treated as a CLI command.</p><p></p></li><li><p>The command name MUST be the filename without extension.</p><p></p></li></ul><p></p><h3><strong>5.2 Execution Modes</strong></h3><p></p><p>TerMoonUs MAY implement either:</p><p></p><h4><strong>Mode A — External Interpreter Execution</strong></h4><p></p><ul><li><p>Launch interpreter as a subprocess</p><p></p></li><li><p>Communicate via stdin/stdout protocol</p><p></p></li></ul><p></p><h4><strong>Mode B — Embedded Lua VM</strong></h4><p></p><ul><li><p>Load script into an embedded Lua engine</p><p></p></li><li><p>Bind TerMoonUs APIs directly</p><p></p></li></ul><p></p><p>Both modes MUST expose the same Lua API surface.</p><p></p><h2><strong>6. Lua API Specification</strong></h2><p></p><p>All APIs MUST be available under the global namespace:</p><p></p><p>Code</p><pre><code>TerMoonUs.&lt;module&gt;.&lt;function&gt;
</code></pre><h3><strong>6.1 Session API</strong></h3><p></p><h4><strong>6.1.1 </strong><code>start.session()</code></h4><p></p><p><strong>Behavior:</strong></p><p></p><ul><li><p>Allocates a new session ID</p><p></p></li><li><p>Clears session state</p><p></p></li><li><p>Applies prompt and theme</p><p></p></li><li><p>Begins CLI lifecycle</p><p></p></li></ul><p></p><p><strong>Lua Signature:</strong></p><p></p><p>Code</p><pre><code>TerMoonUs.start.session()
</code></pre><h4><strong>6.1.2 </strong><code>end.session()</code></h4><p></p><p><strong>Behavior:</strong></p><p></p><ul><li><p>Terminates the current CLI session</p><p></p></li><li><p>Returns control to the main TerMoonUs shell</p><p></p></li></ul><p></p><p><strong>Lua Signature:</strong></p><p></p><p>Code</p><pre><code>TerMoonUs.end.session()
</code></pre><h3><strong>6.2 Text API</strong></h3><p></p><h4><strong>6.2.1 </strong><code>text.print(text, color_hex)</code></h4><p></p><p><strong>Behavior:</strong></p><p></p><ul><li><p>Prints text to terminal output</p><p></p></li><li><p>Applies color if provided</p><p></p></li></ul><p></p><p><strong>Lua Signature:</strong></p><p></p><p>Code</p><pre><code>TerMoonUs.text.print(string text, string|nil color_hex)
</code></pre><h3><strong>6.3 Input API</strong></h3><p></p><h4><strong>6.3.1 </strong><code>ask.question(question, color)</code></h4><p></p><p><strong>Behavior:</strong></p><p></p><ul><li><p>Displays question in specified color</p><p></p></li><li><p>Blocks until user enters input</p><p></p></li><li><p>Returns input string</p><p></p></li></ul><p></p><p><strong>Lua Signature:</strong></p><p></p><p>Code</p><pre><code>local answer = TerMoonUs.ask.question(string question, string|nil color)
</code></pre><h3><strong>6.4 Execution API</strong></h3><p></p><h4><strong>6.4.1 </strong><code>run.file(filepath, arguments_for_it)</code></h4><p></p><p><strong>Behavior:</strong></p><p></p><ul><li><p>Executes a Lua script or binary</p><p></p></li><li><p>Arguments MUST be passed as a Lua table of strings</p><p></p></li></ul><p></p><p><strong>Lua Signature:</strong></p><p></p><p>Code</p><pre><code>TerMoonUs.run.file(string filepath, table arguments)
</code></pre><p><strong>Rules:</strong></p><p></p><ul><li><p>If file ends with <code>.lua</code> or <code>.luac</code>, use the associated interpreter</p><p></p></li><li><p>Otherwise, treat as a system binary</p><p></p></li></ul><p></p><h2><strong>7. UI/UX Specification</strong></h2><p></p><h3><strong>7.1 Visual Theme</strong></h3><p></p><ul><li><p>Background MUST be solid black (<code>#000000</code>)</p><p></p></li><li><p>UI MUST include an RGB Flow effect</p><p></p></li></ul><p></p><h3><strong>7.2 RGB Flow Behavior</strong></h3><p></p><ul><li><p>RGB hue MUST cycle smoothly over time</p><p></p></li><li><p>Flow MAY be applied to:</p><p></p><ul><li><p>Window borders</p><p></p></li><li><p>Status bar</p><p></p></li><li><p>Dynamic prompt segments</p><p></p></li></ul><p></p></li></ul><p></p><h3><strong>7.3 Terminal Layout</strong></h3><p></p><p>TerMoonUs MUST include:</p><p></p><ul><li><p>Output viewport</p><p></p></li><li><p>Input line</p><p></p></li><li><p>Scrollback buffer</p><p></p></li><li><p>Session status indicator</p><p></p></li></ul><p></p><h2><strong>8. Protocol Specification (if using external interpreters)</strong></h2><p></p><h3><strong>8.1 API Command Format</strong></h3><p></p><p>Lua scripts MUST communicate with TerMoonUs using special stdout lines:</p><p></p><p>Code</p><pre><code>__TERMOONUS_API:&lt;module&gt;.&lt;function&gt;:&lt;arg1&gt;:&lt;arg2&gt;:...
</code></pre><p>Example:</p><p></p><p>Code</p><pre><code>__TERMOONUS_API:text.print:#00ff00:Hello world
</code></pre><h3><strong>8.2 Escaping Rules</strong></h3><p></p><ul><li><p><code>:</code> inside arguments MUST be escaped as <code>\:</code></p><p></p></li><li><p><code>\</code> MUST be escaped as <code>\\</code></p><p></p></li></ul><p></p><h2><strong>9. Error Handling Specification</strong></h2><p></p><p>TerMoonUs MUST:</p><p></p><ul><li><p>Display interpreter errors in red (<code>#ff0000</code>)</p><p></p></li><li><p>Display missing interpreter errors clearly</p><p></p></li><li><p>Display malformed PROMPT.xml errors at startup</p><p></p></li><li><p>Fail gracefully if a CLI script crashes</p><p></p></li></ul><p></p><h2><strong>10. Security Model</strong></h2><p></p><ul><li><p>TerMoonUs MUST NOT require root/sudo</p><p></p></li><li><p>All file access MUST be sandboxed to:</p><p></p><ul><li><p>The CLI’s working directory</p><p></p></li><li><p>Explicit paths provided by the user</p><p></p></li></ul><p></p></li><li><p>TerMoonUs MUST NOT allow Lua scripts to modify TerMoonUs-Settings unless explicitly permitted</p><p></p></li></ul><p></p><h2><strong>11. Versioning</strong></h2><p></p><p>TerMoonUs MUST include:</p><p></p><ul><li><p>Internal version number (e.g., <code>1.0.0</code>)</p><p></p></li><li><p>API version number (e.g., <code>LuaAPI 1.0</code>)</p><p></p></li><li><p>Settings schema version (e.g., <code>PROMPT 1.0</code>)</p><p></p></li></ul><p></p><h2><strong>12. Example CLI Script</strong></h2><p></p><p>lua</p><pre><code>TerMoonUs.start.session()

TerMoonUs.text.print("Welcome to MoonCLI!", "#00ffcc")

local name = TerMoonUs.ask.question("What is your moon name? ", "#ffcc00")
TerMoonUs.text.print("Nice to meet you, " .. name .. "!", "#ffffff")

local action = TerMoonUs.ask.question("Run build.lua? (y/n) ", "#ff8800")
if action == "y" then
    TerMoonUs.run.file("build.lua", {})
else
    TerMoonUs.text.print("Okay, maybe next time.", "#888888")
end

TerMoonUs.end.session()</code></pre>